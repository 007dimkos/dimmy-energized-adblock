name: Обновление списков

on:
  schedule:
    - cron: '25 1 * * *'
  workflow_dispatch:

jobs:
  Update_lists:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Важно: дает право пушить файл .srs обратно в репозиторий

    steps:
    - name: Чекаем репо
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Устанавливаем GO
      uses: actions/setup-go@v5
      with:
        go-version: 'stable'

    - name: Скачиваем и обрабатываем список доменов
      run: |
        mkdir -p data
        curl -LsO https://raw.githubusercontent.com/hagezi/dns-blocklists/main/wildcard/pro-onlydomains.txt
        grep -v '^#' pro-onlydomains.txt > temp_cleaned.txt
        
        # Фильтрация (exclude/include)
        if [ -f exclude.list ]; then
          grep -vFf exclude.list temp_cleaned.txt > data/hagezi-pro
        else
          mv temp_cleaned.txt data/hagezi-pro
        fi
        
        if [ -f include.list ]; then
          cat include.list >> data/hagezi-pro
          sort -uo data/hagezi-pro data/hagezi-pro
        fi
        
        # Подготовка JSON для Sing-Box
        cat << EOF > dimmyenergizi.json
        {
            "version": 2,
            "rules": [{ "domain_suffix": [] }]
        }
        EOF
        jq --slurpfile domains <(jq -Rsc 'split("\n") | map(select(length > 0))' data/hagezi-pro) \
          '.rules[0].domain_suffix = $domains[0]' dimmyenergizi.json > temp.json && mv temp.json dimmyenergizi.json

    - name: Компиляция dimmyenergizi.dat
      run: |
        go mod download
        go run main.go
        # Твой исправленный main.go теперь сам создает dimmyenergizi.dat

    - name: Устанавливаем Sing-Box
      run: |
        bash <(curl -Ls https://sing-box.app/deb-install.sh)
        
    - name: Компиляция dimmyenergizi.srs
      run: |
        sing-box rule-set compile dimmyenergizi.json
        # Если sing-box создает файл dimmyenergizi.json.srs, переименовываем его:
        [ -f dimmyenergizi.json.srs ] && mv dimmyenergizi.json.srs dimmyenergizi.srs || echo "SRS уже назван верно"

    - name: Компиляция dimmyenergizi.mrs (Mihomo)
      run: |
        MIHOMO_URL=$(curl -Ls https://api.github.com/repos/MetaCubeX/mihomo/releases/latest | jq -r '.assets[] | select(.name | test("mihomo-linux-amd64-v3-v.*\\.gz$")) | .browser_download_url')
        curl -sSLf "$MIHOMO_URL" -o mihomo.gz && gunzip mihomo.gz && chmod +x mihomo
        sed 's/^/+./' data/hagezi-pro > mihomo_domains.txt
        ./mihomo convert-ruleset domain text mihomo_domains.txt dimmyenergizi.mrs

    # Второе твое условие: копирование и обновление .srs в корне репозитория
    - name: Обновление dimmyenergizi.srs в корне репозитория
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        # Добавляем файл .srs (он уже находится в корне рабочей директории после компиляции)
        git add dimmyenergizi.srs
        git commit -m "chore: auto-update dimmyenergizi.srs [skip ci]" || echo "Нет изменений для коммита"
        git push origin main

    - name: Ставим дату релиза
      id: set-date
      run: echo "RELEASE_DATE=$(date +%d.%m.%Y)" >> $GITHUB_ENV

    - name: Создание GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: "release-${{ env.RELEASE_DATE }}"
        name: "Списки от ${{ env.RELEASE_DATE }}"
        files: |
          dimmyenergizi.dat
          dimmyenergizi.srs
          dimmyenergizi.mrs
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Удаление старых релизов
      uses: dev-drprasad/delete-older-releases@v0.3.4
      with:
        keep_latest: 3
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
