name: Обновление списков

on:
  schedule:
    - cron: '25 1 * * *'
  workflow_dispatch:

jobs:
  Update_lists:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Важно для записи в репозиторий

    steps:
    - name: Чекаем репо
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Устанавливаем GO
      uses: actions/setup-go@v5
      with:
        go-version: 'stable'

    - name: Скачиваем и обрабатываем список доменов
      run: |
        mkdir -p data
        curl -LsO https://raw.githubusercontent.com/hagezi/dns-blocklists/main/wildcard/pro-onlydomains.txt
        grep -v '^#' pro-onlydomains.txt > temp_cleaned.txt
        
        # Фильтрация и создание исходного файла для GO
        if [ -f exclude.list ]; then
          grep -vFf exclude.list temp_cleaned.txt > data/hagezi-pro
        else
          mv temp_cleaned.txt data/hagezi-pro
        fi
        
        if [ -f include.list ]; then
          cat include.list >> data/hagezi-pro
          sort -uo data/hagezi-pro data/hagezi-pro
        fi
        
        # Подготовка JSON для Sing-Box
        cat << EOF > dimmyenergizi.json
        {
            "version": 2,
            "rules": [{ "domain_suffix": [] }]
        }
        EOF
        jq --slurpfile domains <(jq -Rsc 'split("\n") | map(select(length > 0))' data/hagezi-pro) \
          '.rules[0].domain_suffix = $domains[0]' dimmyenergizi.json > temp.json && mv temp.json dimmyenergizi.json

    - name: Компиляция dimmyenergizi.dat (V2Ray)
      run: |
        go mod download
        go run ./
        # Теперь GO сам создаст dimmyenergizi.dat

    - name: Компиляция dimmyenergizi.srs (Sing-Box)
      run: |
        bash <(curl -Ls https://sing-box.app/deb-install.sh)
        sing-box rule-set compile dimmyenergizi.json
        # Переименуем, так как sing-box добавит .srs к имени json
        mv dimmyenergizi.json.srs dimmyenergizi.srs

    - name: Компиляция dimmyenergizi.mrs (Mihomo)
      run: |
        MIHOMO_URL=$(curl -Ls https://api.github.com/repos/MetaCubeX/mihomo/releases/latest | jq -r '.assets[] | select(.name | test("mihomo-linux-amd64-v3-v.*\\.gz$")) | .browser_download_url')
        curl -sSLf "$MIHOMO_URL" -o mihomo.gz && gunzip mihomo.gz && chmod +x mihomo
        sed 's/^/+./' data/hagezi-pro > mihomo_domains.txt
        ./mihomo convert-ruleset domain text mihomo_domains.txt dimmyenergizi.mrs

    - name: Обновление SRS в корне репозитория
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        # dimmyenergizi.srs уже находится в корне после шага компиляции
        git add dimmyenergizi.srs
        git commit -m "Auto-update dimmyenergizi.srs [skip ci]" || echo "Нет изменений"
        git push

    - name: Создание релиза
      uses: softprops/action-gh-release@v2
      with:
        tag_name: "release-${{ github.run_number }}"
        name: "Update ${{ github.run_number }}"
        files: |
          dimmyenergizi.dat
          dimmyenergizi.srs
          dimmyenergizi.mrs
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Очистка старых данных
      uses: dev-drprasad/delete-older-releases@v0.3.4
      with:
        keep_latest: 3
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
