name: Build Dimmy Energized SRS
on:
  workflow_dispatch:
  schedule:
    - cron: '0 5 * * *' # Обновление ежедневно в 5 утра по UTC

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Raw Lists to Root
        run: |
          curl -L "https://raw.githubusercontent.com/hagezi/dns-blocklists/main/wildcard/pro-onlydomains.txt" -o pro.txt
          curl -L "https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/wildcard/fake-onlydomains.txt" -o fake.txt
          curl -L "https://cdn.jsdelivr.net/gh/hagezi/dns-blocklists@latest/wildcard/doh-vpn-proxy-bypass-onlydomains.txt" -o bypass.txt

      - name: Commit Raw Files
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add pro.txt fake.txt bypass.txt
          git commit -m "Daily sync from HaGeZi" || echo "No changes to commit"
          git push

      - name: Install Sing-box
        run: |
          curl -Lo sing-box.tar.gz https://github.com/SagerNet/sing-box/releases/download/v1.10.1/sing-box-1.10.1-linux-amd64.tar.gz
          tar -xzf sing-box.tar.gz
          sudo mv sing-box-*/sing-box /usr/local/bin/

      - name: Process and Exclude
        run: |
          # 1. Объединяем три списка в один
          cat pro.txt fake.txt bypass.txt > raw_all.txt
          
          # 2. Чистим комментарии и пустые строки
          grep -v '^#' raw_all.txt | grep -v '^[[:space:]]*$' > temp_cleaned.txt
          
          # 3. Фильтруем исключения (чтобы X и картинки работали)
          if [ -f exclude.list ] && [ -s exclude.list ]; then
            echo "Применяем исключения из exclude.list..."
            grep -vFf exclude.list temp_cleaned.txt > temp_filtered.txt
          else
            mv temp_cleaned.txt temp_filtered.txt
          fi

          # 4. Добавляем свои домены для блокировки (например, для Habr)
          if [ -f include.list ] && [ -s include.list ]; then
            echo "Добавляем домены из include.list..."
            cat include.list >> temp_filtered.txt
          fi

          # 5. Финальная сортировка и удаление дублей
          sort -u temp_filtered.txt -o clean.txt

      - name: Create JSON and Compile SRS
        run: |
          jq -R -s 'split("\n") | map(select(length > 0)) | {version: 1, rules: [{domain_suffix: .}]}' clean.txt > rules.json
          sing-box rule-set compile rules.json -o dimmyenergizi.srs

      - name: Release SRS File
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: "Dimmy Energized SRS (Daily Update)"
          files: dimmyenergizi.srs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
