name: Build Dimmy Energized SRS
on:
  workflow_dispatch:
  schedule:
    - cron: '0 5 * * *' # Обновление ежедневно в 5 утра по UTC

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Raw List
        run: |
          # Скачиваем только актуальный список Hagezi Pro
          curl -L "https://raw.githubusercontent.com/hagezi/dns-blocklists/main/wildcard/pro-onlydomains.txt" -o pro.txt

      - name: Commit Raw File
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add pro.txt
          git commit -m "Daily sync from HaGeZi" || echo "No changes to commit"
          git push

      - name: Install Sing-box
        run: |
          curl -Lo sing-box.tar.gz https://github.com/SagerNet/sing-box/releases/download/v1.10.1/sing-box-1.10.1-linux-amd64.tar.gz
          tar -xzf sing-box.tar.gz
          sudo mv sing-box-*/sing-box /usr/local/bin/

      - name: Process and Exclude
        run: |
          # 1. Чистим комментарии из основного списка
          grep -v '^#' pro.txt > temp_cleaned.txt
          
          # 2. Фильтруем через exclude.list (логика zxc-rv)
          if [ -f exclude.list ] && [ -s exclude.list ]; then
            grep -vFf exclude.list temp_cleaned.txt > filtered.txt
          else
            mv temp_cleaned.txt filtered.txt
          fi
          
          # 3. Добавляем свои домены из include.list (если файл есть и не пустой)
          if [ -f include.list ] && [ -s include.list ]; then
            cat include.list >> filtered.txt
            sort -u filtered.txt -o filtered.txt
          fi
          
          # 4. Финальная очистка и подготовка списка
          grep -v '^[[:space:]]*$' filtered.txt | sort -u > clean.txt

      - name: Create JSON and Compile SRS
        run: |
          # Превращаем в JSON формат sing-box
          jq -R -s 'split("\n") | map(select(length > 0)) | {version: 1, rules: [{domain_suffix: .}]}' clean.txt > rules.json
          # Компилируем в бинарный .srs
          sing-box rule-set compile rules.json -o dimmyenergizi.srs

      - name: Release SRS File
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest
          name: "Dimmy Energized SRS (Daily Update)"
          files: dimmyenergizi.srs
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
